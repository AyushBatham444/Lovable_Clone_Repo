package com.project.demo.llm.advisors;

import com.project.demo.Service.ProjectFileService;
import com.project.demo.dto.project.FileNode;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClientRequest;
import org.springframework.ai.chat.client.ChatClientResponse;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisor;
import org.springframework.ai.chat.client.advisor.api.StreamAdvisorChain;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.MessageType;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Slf4j
@Component
@RequiredArgsConstructor
public class FileTreeContextAdvisor implements StreamAdvisor {

    private final ProjectFileService projectFileServiceObj;


    //Every time you ask the chatbot a question, this advisor automatically adds the projectâ€™s file tree to the prompt before the LLM answers.
    @Override
    public Flux<ChatClientResponse> adviseStream(ChatClientRequest request, StreamAdvisorChain streamAdvisorChain) {

        Map<String,Object> context=request.context();
        Long projectId=Long.parseLong(context.getOrDefault("projectId",0).toString());

        ChatClientRequest augmentedChatClientRequest= augmentRequestWithFileTree(request,projectId);

        return streamAdvisorChain.nextStream(augmentedChatClientRequest);
    }

    private ChatClientRequest augmentRequestWithFileTree(ChatClientRequest request, Long projectId) {

    List<org.springframework.ai.chat.messages.Message> incomingMessages=request.prompt().getInstructions();

    Message systemMessage=incomingMessages.stream()
            .filter(m->m.getMessageType()== MessageType.SYSTEM)
            .findFirst()
            .orElse(null);

    List<Message> userMessages=incomingMessages.stream()
            .filter(m->m.getMessageType() !=MessageType.SYSTEM)
            .toList();

    List<Message> allMessages =new ArrayList<>();
    //now add original system message
        if(systemMessage!=null)
        {
        allMessages.add(systemMessage);
        }

    List<FileNode> fileTree=projectFileServiceObj.getFileTree(projectId).files();
    String fileTreeContext="\n\n ---- FILE_TREE ----\n"+fileTree.toString(); // so that the llm can distinguish this file tree differnetly
    allMessages.add(new SystemMessage(fileTreeContext));

    allMessages.addAll(userMessages);

    return  request.mutate()
            .prompt(new Prompt(allMessages,request.prompt().getOptions()))
            .build();

    }

    @Override
    public String getName() {
        return "FileTreeContextAdvisor";
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
